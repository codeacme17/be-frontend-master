## 了解 Javascript 的编译时和运行时

Javascript 的执行过程可以分为编阶段(compile-parse) 和运行时阶段(runtime-parse)

### 编译阶段

虽然 Javascript 不是传统的编译型语言，但它在执行之前会经历一个简短的编译阶段。这个阶段主要做一下几件事

- 词法分析

  将源代码分解成一些列的词法单元（tokens），例如关键字、运算符、数字、字符串等

- 词法分析

  将词法单元组织成一个结构化的表示形式（通常是一颗抽象语法树，AST），这反映了代码的逻辑和语法结构

- 预编译处理

  - 变量和函数提升（Hoisting）

    函数声明和使用 `var` 关键字声明的变量在它们所在作用域的顶部被声明（但不赋值）

  - 作用域确定

    此时，基于代码的书写位置确定每个变量和函数的作用域，即词法作用域

  - 预编译和优化

    一些现代 Javascript 引擎会进行预解析和初步优化

### 运行时阶段

在该阶段，Javascript 代码实际被执行，主要包括以下几个方面

- 执行上下文创建

  没当函数被调用时，都会为该函数创建一个新的执行上下文。全局代码也运行在一个全局执行上下文中

- 词法环境和变量环境的设置

  - 词法环境（Lexical Environment）

    它包含了标识符（比如变量和函数名）与它们各自的值的映射。词法环境还包含了一个指向外部环境的引用，形成了所谓的作用域链。

  - 变量环境（Variable Environment）

    在 ECMAScript 6 之前，词法环境和变量环境基本是相同的。但自 ES6 起，变量环境特指 var 声明的变量的环境，而词法环境则包括 let 和 const 以及函数声明。

- 变量初始化和赋值

  - `var` 声明的变量在编译阶段已被提升并初始化为 `undefined`

  - `let` 和 `const` 声明的变量也被提升，但不初始化，会被定义为 `uninitialnize`，直到代码执行到它们的定义位置，进入”暂时性死区“（Temporal Dead Zone，TDZ）之前他们都是不可访问的

  - 函数声明在编译阶段就已经被完全初始化

- 代码执行

  按照代码的逻辑顺序执行，包括变量赋值、函数调用等。在函数执行过程中，根据当前的执行上下文和作用域链解析变量和函数名

- 闭包的形成

  当函数能够记住并访问所在的词法作用域时，即使该函数在其词法作用域外执行，闭包就会发生。这是通过函数的 `[[scope]]` 属性来实现的，它存储了函数定义时的此法环境
