## Vue 中的 DOM 更新策略

Vue 使用了一种高效的 DOM 更新策略，旨在最小化前端性能成本，同时保证用户界面与底层数据状态保持同步。这种策略基于虚拟 DOM（Virtual DOM）和异步队列的概念

### 虚拟 DOM

- 定义和作用

  虚拟 DOM 是一个轻量级的 Javascript 对象，作为真实 DOM 的抽象表示。它允许 Vue 在内存中模拟 DOM 操作，而不是直接操作昂贵的真实 DOM 元素。通过这种方式，Vue 可以批量计算和最小化对真实 DOM 的操作，从而提高性能

- Diff 算法

  当数据变化导致视图需要更新时，Vue 会生成一个新的虚拟 DOM 树，并将其与旧的虚拟 DOM 树进行比较（这个过程称为 Diff）。Vue 的 Diff 算法尝试以最小的操作次数更新真实 DOM，它通过比较新旧虚拟 DOM 树中的节点的差异来实现，只对有变化的部分进行真实 DOM 的更新

### 异步更新队列

- 批量更新

  Vue 采用异步更新策略来避免不必要的重复渲染。当响应式数据发生变化时，Vue 将个更新操作放入异步队列中。在同一事件循环中，所有数据变动都会被缓存，直到事件循环结束 Vue 才会清空队列，并执行实际的组件更新

- `nextTick`

  开发者可以使用 `Vue.nextTick()` 方法在 DOM 更新完成后执行某些操作。`nextTick` 允许开发者在数据变化后等待 Vue 完成 DOM 跟新，然后运行回调函数。这对于依赖最新 DOM 状态的操作非常有用

### 异步更新策略的目的

- 性能优化

  在 Web 开发中，DOM 操作是昂贵的，频繁的、不必要的 DOM 更新会导致性能平静。如果 Vue 在数据变化后立即更新 DOM，那么在一个事件循环中的多次数据变化将导致多次 DOM 更新。这不仅效率低下，还会导致用户界面的短暂卡顿，影响用户体验

  Vue 的异步更新策略通过维护一个队列，将所有数据变化事件收集起来，在事件循环结束时一次性处理。这样，即使一个事件循环中有多处数据变化，Vue 也只会更新一次 DOM，从而显著提高应用的性能

- 避免不必要的计算

  在 Vue 应用中，视图是响应式数据的函数。理想情况下，只有当数据发生变化时，才需要重新计算视图。如果没有异步更新策略，每次数据变化都会触发视图的重新计算，这在某些情况下可能导致大量不必要的计算，尤其是当多个数据变化彼此独立且在同一事件循环中时

  通过将更新推迟到事件循环的末尾，Vue 可以在实际进行更新之前检查哪些组件真正需要更新。这不仅减少了 DOM 操作的次数，还避免了不必要的计算和渲染，进一步提升了性能

### 更新机制的具体流程

- 数据响应式变化：当响应式数据发生变化是，Vue 会通知订阅者（依赖），触发重新渲染

- 虚拟 DOM 重新渲染：Vue 会生成新的虚拟 DOM 树，并与上一次的虚拟 DOM 树进行 Diff 比较

- 计算最小操作：通过 Diff 算法，Vue 计算出更新真实 DOM 所需的最小操作集

- 异步更新队列：将 DOM 更新擦欧总放入异步队列中，等待批量处理

- 执行 DOM 更新：在事件循环的微任务阶段，Vue 清空更新队列，执行所有累计的 DOM 更新

- nextTick 回调执行：一旦 DOM 更新完成，`nextTick` 回调被调用
