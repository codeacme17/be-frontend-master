## 理解 WebSocket 协议的底层原理、与 HTTP 的区别

Websocket 是一种网络通信协议，提供了在单个 TCP 连接上进行全双工通讯的能力。WebSocket 旨在建立一个持久的连接，并允许数据在客户端和服务器之间双向传输，从而使得实现通信变得更加高效。WebSocket 协议在 2011 年被 IETF 标准化为 RFC 6455

### 底层原理

- 握手

  Websocket 连接开始于一个 HTTP 请求，这个过程称之为 “握手”。客户端发送一个特殊的 HTTP 请求，请求头包括 `Upgrade: websocket` 和 `Connection: Upgrade`，表明客户端希望将连接升级到 WebSocket。如果服务器支持 WebSocket，它会以状态码 `101 Switching Protocols` 响应，同意升级协议

- 升级协议

  一旦握手成功，连接即被升级从 HTTP 协议转换到 WebSocket 协议，此时连接保持打开状态，直到由客户端或服务器主动关闭

- 数据帧

  在 WebSocket 连接中，数据通过称为”帧“的消息传输。WebSocket 协议定义了多种帧类型，用于传输数据、控制消息（如关闭连接、ping/pong 心跳检测）等。数据可以被分割成多个帧进行发送，并在接收端进行组装

- 全双工通信

  WebSocket 提供了全双工通信的能力，即客户端和服务器可以同时发送和接收消息，这为实时交互应用提供了高效的通信机制

### WebSocket 与 HTTP 的区别

- 持久连接

  WebSocket 提供了一种在客户端和服务器之间建立持久连接的机制，允许数据双向流动，而 HTTP 请求/响应模型则是无状态的，通常需要为每个请求建立新的连接（虽然 HTTP/1.1 支持持久连接）

- 头部开销

  WebSocket 在握手之后的数据传输相比 HTTP 具有更低级的头部开销，因为数据包的头部信息更小，而 HTTP 每次请求都需要携带完整的头部

- 全双工 vs 半双工

  WebSocket 支持全双工通信，即客户端和服务器可以同时发送和接收数据。HTTP 通常是半双工的，请求一次只能由一方发起，虽然 HTTP/2 引入了多路复用技术，改善了这一点

- 协议升级

  WebSocket 连接开始于 HTTP 请求，通过 Upgrade 头部实现从 HTTP 到 WebSocket 的协议切换。HTTP 连接使用标准的 HTTP 协议

- 使用场景

  WebSocket 适用于需要实时双向通信的应用，如在线游戏、聊天应用和实时数据传输。HTTP 更适合传统的请求/响应模型应用，如网页浏览、表单提交等
